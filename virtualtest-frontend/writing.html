<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Writing Module - VirtuaTest</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    <style>
        .loading-overlay {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        .loading-overlay.hidden { display: none; }
        .loading-spinner {
            width: 60px; height: 60px;
            border: 4px solid #e2e8f0;
            border-top-color: #059669;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-text {
            margin-top: 20px;
            font-size: 1.2rem;
            color: #1e293b;
            font-weight: 600;
        }

        .topic-selection {
            padding: 40px;
        }
        .topic-header {
            text-align: center;
            margin-bottom: 40px;
        }
        .topic-header h2 {
            font-size: 2rem;
            color: #1e293b;
            margin-bottom: 10px;
        }
        .topic-header p {
            color: #64748b;
        }

        .topics-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 25px;
            max-width: 1000px;
            margin: 0 auto;
        }

        .topic-card {
            background: linear-gradient(145deg, #ffffff, #f0fdf4);
            border: 2px solid #e2e8f0;
            border-radius: 20px;
            padding: 30px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: left;
        }
        .topic-card:hover {
            transform: translateY(-8px);
            border-color: #059669;
            box-shadow: 0 15px 30px rgba(5, 150, 105, 0.15);
        }
        .topic-card .icon {
            width: 60px; height: 60px;
            background: #dcfce7;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            color: #059669;
            margin-bottom: 20px;
        }
        .topic-card h3 {
            font-size: 1.2rem;
            color: #1e293b;
            margin-bottom: 10px;
        }
        .topic-card p {
            color: #64748b;
            font-size: 0.95rem;
            line-height: 1.6;
        }

        .editor-section {
            display: none;
            height: calc(100vh - 200px);
        }
        .editor-section.active {
            display: block;
        }

        .editor-container {
            display: grid;
            grid-template-columns: 350px 1fr;
            height: 100%;
            background: white;
            border-radius: 16px;
            overflow: hidden;
        }

        .editor-sidebar {
            background: #f0fdf4;
            padding: 30px;
            border-right: 2px solid #dcfce7;
        }
        .editor-sidebar h3 {
            color: #1e293b;
            margin-bottom: 10px;
        }
        .editor-sidebar .topic-text {
            color: #059669;
            font-size: 1.1rem;
            font-weight: 600;
            line-height: 1.6;
            margin-bottom: 30px;
        }

        .criteria-box {
            background: white;
            border-radius: 12px;
            padding: 20px;
        }
        .criteria-box h4 {
            color: #059669;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .criteria-list {
            list-style: none;
            padding: 0;
        }
        .criteria-list li {
            color: #166534;
            font-size: 0.9rem;
            margin-bottom: 10px;
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }
        .criteria-list i {
            color: #22c55e;
            margin-top: 3px;
        }

        .editor-main {
            display: flex;
            flex-direction: column;
            padding: 30px;
        }
        .essay-textarea {
            flex: 1;
            width: 100%;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            font-size: 1rem;
            line-height: 1.8;
            resize: none;
            font-family: inherit;
        }
        .essay-textarea:focus {
            outline: none;
            border-color: #059669;
        }

        .editor-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
        }
        .word-count {
            color: #059669;
            font-weight: 600;
        }
        .word-count.over {
            color: #dc2626;
        }

        .btn-submit {
            padding: 14px 30px;
            background: linear-gradient(135deg, #059669, #10b981);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .btn-submit:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(5, 150, 105, 0.3);
        }
        .btn-submit:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loading">
        <div class="loading-spinner"></div>
        <div class="loading-text">Generating Topics...</div>
    </div>

    <nav class="glass-nav">
        <div class="nav-content">
            <div class="logo-area">
                <div class="logo-icon"><i class="fa-solid fa-shapes"></i></div>
                <span>Virtua<span class="gradient-text">Test</span></span>
            </div>
            <div class="user-menu-container">
                <button class="user-menu-btn" id="user-menu-btn" onclick="toggleUserMenu(event)">
                    <i class="fa-solid fa-circle-user"></i>
                    <span class="u-name">Student</span>
                    <i class="fa-solid fa-chevron-down"></i>
                </button>
                <div class="user-menu-dropdown" id="user-menu-dropdown">
                    <button class="user-menu-item" onclick="handleLogout()">
                        <i class="fa-solid fa-right-from-bracket"></i> Logout
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <main class="app-container">
        <section id="writing">
            <div class="module-frame">
                <div class="frame-header header-green">
                    <a href="index.html" class="btn-back"><i class="fa-solid fa-arrow-left"></i> Dashboard</a>
                    <h2>Writing Assessment</h2>
                    <div class="timer t-green"><i class="fa-regular fa-clock"></i> <span id="timer">40:00</span></div>
                </div>

                <!-- Topic Selection -->
                <div class="topic-selection" id="topic-selection">
                    <div class="topic-header">
                        <h2>Select Your Essay Topic</h2>
                        <p>Choose one topic that interests you the most</p>
                    </div>
                    <div class="topics-grid" id="topics-grid">
                        <!-- JS ile doldurulacak -->
                    </div>
                </div>

                <!-- Essay Editor -->
                <div class="editor-section" id="editor-section">
                    <div class="editor-container">
                        <div class="editor-sidebar">
                            <span class="tag t-bg-green">Selected Topic</span>
                            <h3 id="selected-topic-title">Topic</h3>
                            <p class="topic-text" id="selected-topic-text"></p>

                            <div class="criteria-box">
                                <h4><i class="fa-solid fa-list-check"></i> Assessment Criteria</h4>
                                <ul class="criteria-list">
                                    <li><i class="fa-solid fa-check"></i> Write between <strong>250-400 words</strong></li>
                                    <li><i class="fa-solid fa-check"></i> Use an <strong>academic tone</strong></li>
                                    <li><i class="fa-solid fa-check"></i> Include intro, body, conclusion</li>
                                    <li><i class="fa-solid fa-check"></i> Check grammar & spelling</li>
                                </ul>
                            </div>
                        </div>

                        <div class="editor-main">
                            <textarea 
                                class="essay-textarea" 
                                id="essay-textarea" 
                                placeholder="Start writing your essay here..."
                                oninput="updateWordCount()"
                            ></textarea>

                            <div class="editor-footer">
                                <span class="word-count" id="word-count">
                                    <i class="fa-solid fa-pen-nib"></i> Words: 0 / 400
                                </span>
                                <button class="btn-submit" id="btn-submit" onclick="submitEssay()">
                                    Submit Essay <i class="fa-solid fa-paper-plane"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <script src="api.js"></script>
    <script>
        let moduleContent = null;
        let topics = [];
        let selectedTopic = null;
        let sessionId = null;
        let timerInterval = null;
        let timeLeft = 40 * 60;

        document.addEventListener('DOMContentLoaded', async function() {
            if (!isLoggedIn()) {
                window.location.href = 'login.html';
                return;
            }
            updateUserDisplay();
            await loadModuleContent();
            startTimer();
        });

        function updateUserDisplay() {
            const user = getUser();
            if (user) {
                document.querySelector('.u-name').textContent = user.full_name || user.email;
            }
        }

        async function loadModuleContent() {
            try {
                const session = getCurrentSession();
                if (!session) {
                    alert('Test session not found!');
                    window.location.href = 'index.html';
                    return;
                }
                sessionId = session.id;

                const response = await apiStartModule(sessionId, 'writing', 'B1');
                moduleContent = response.content;

                displayTopics();
                hideLoading();

            } catch (error) {
                console.error('Content loading error:', error);
                alert('Error loading content: ' + error.message);
                hideLoading();
            }
        }

        function displayTopics() {
            topics = moduleContent.topics || [];

            const grid = document.getElementById('topics-grid');
            grid.innerHTML = '';

            const icons = [
                'fa-plane-departure',
                'fa-graduation-cap',
                'fa-laptop-house'
            ];

            topics.forEach((topic, index) => {
                const card = document.createElement('div');
                card.className = 'topic-card';
                card.onclick = () => selectTopic(index);

                card.innerHTML = `
                    <div class="icon"><i class="fa-solid ${icons[index % 3]}"></i></div>
                    <span class="tag t-bg-green">Topic ${index + 1}</span>
                    <h3>Essay Topic</h3>
                    <p>${topic}</p>
                `;

                grid.appendChild(card);
            });
        }

        function selectTopic(index) {
            selectedTopic = topics[index];

            document.getElementById('selected-topic-title').textContent = `Topic ${index + 1}`;
            document.getElementById('selected-topic-text').textContent = selectedTopic;

            document.getElementById('topic-selection').style.display = 'none';
            document.getElementById('editor-section').classList.add('active');
        }

        function updateWordCount() {
            const text = document.getElementById('essay-textarea').value.trim();
            const words = text ? text.split(/\s+/).filter(w => w.length > 0).length : 0;

            const countEl = document.getElementById('word-count');
            countEl.innerHTML = `<i class="fa-solid fa-pen-nib"></i> Words: ${words} / 400`;

            if (words > 400) {
                countEl.classList.add('over');
            } else {
                countEl.classList.remove('over');
            }
        }

        async function submitEssay() {
            const essayText = document.getElementById('essay-textarea').value.trim();
            const wordCount = essayText.split(/\s+/).filter(w => w.length > 0).length;

            if (wordCount < 50) {
                alert('Please write at least 50 words.');
                return;
            }

            showLoading('AI is evaluating your essay...');

            try {
                const result = await apiSubmitModule(sessionId, 'writing', {
                    topic: selectedTopic,
                    student_response: essayText
                });

                clearInterval(timerInterval);

                alert(`Writing completed!\n\nScore: ${result.score.toFixed(1)}\nCEFR Level: ${result.cefr_level}`);

                // Session gÃ¼ncelle
                const session = getCurrentSession();
                if (session) {
                    session.completed_modules = session.completed_modules || [];
                    if (!session.completed_modules.includes('writing')) {
                        session.completed_modules.push('writing');
                    }
                    localStorage.setItem('current_session', JSON.stringify(session));
                }

                window.location.href = 'index.html';

            } catch (error) {
                console.error('Submit error:', error);
                alert('Error submitting: ' + error.message);
                hideLoading();
            }
        }

        function startTimer() {
            timerInterval = setInterval(() => {
                timeLeft--;
                const mins = Math.floor(timeLeft / 60);
                const secs = timeLeft % 60;
                document.getElementById('timer').textContent = 
                    `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;

                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    alert('Time is up!');
                    submitEssay();
                }
            }, 1000);
        }

        function showLoading(text) {
            document.getElementById('loading').classList.remove('hidden');
            document.querySelector('.loading-text').textContent = text;
        }

        function hideLoading() {
            document.getElementById('loading').classList.add('hidden');
        }
    </script>
</body>
</html>